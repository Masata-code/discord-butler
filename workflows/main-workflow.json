{
  "name": "Discord Butler - Main Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "discord-butler-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "4a9b5d4e-webhook",
      "name": "Discord Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300],
      "webhookId": "discord-butler-main",
      "typeVersion": 1
    },
    {
      "parameters": {
        "functionCode": "// Discord WebhookÊ§úË®º\nconst { type, data } = $input.first().json;\n\n// Discord pingÊ§úË®º\nif (type === 1) {\n  return [{ json: { type: 1 } }];\n}\n\n// ÈÄöÂ∏∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Âá¶ÁêÜ\nif (type === 2 && data) {\n  const userId = data.member?.user?.id || data.user?.id;\n  const username = data.member?.user?.username || data.user?.username;\n  const message = data.options?.[0]?.value || '';\n  const channelId = data.channel_id;\n  \n  return [{\n    json: {\n      userId,\n      username,\n      message,\n      channelId,\n      interactionId: data.id,\n      interactionToken: data.token,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nthrow new Error('Invalid Discord interaction type');"
      },
      "id": "b3c6d7e8-parser",
      "name": "Parse Discord Data",
      "type": "n8n-nodes-base.code",
      "position": [450, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM user_profiles WHERE discord_id = $1",
        "additionalFields": {
          "queryParams": "={{ [$json.userId] }}"
        }
      },
      "id": "e5f6g7h8-db-user",
      "name": "Get User Profile",
      "type": "n8n-nodes-base.postgres",
      "position": [650, 200],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.length }}",
              "operation": "equal",
              "value2": 0
            }
          ]
        }
      },
      "id": "i9j0k1l2-if",
      "name": "New User?",
      "type": "n8n-nodes-base.if",
      "position": [850, 300],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO user_profiles (user_id, discord_id, discord_username) VALUES ($1, $2, $3) RETURNING *",
        "additionalFields": {
          "queryParams": "={{ [$('Parse Discord Data').item.json.userId, $('Parse Discord Data').item.json.userId, $('Parse Discord Data').item.json.username] }}"
        }
      },
      "id": "m3n4o5p6-create-user",
      "name": "Create User Profile",
      "type": "n8n-nodes-base.postgres",
      "position": [1050, 400],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO sessions (user_id) VALUES ($1) RETURNING session_id",
        "additionalFields": {
          "queryParams": "={{ [$json.user_id || $json[0].user_id] }}"
        }
      },
      "id": "q7r8s9t0-session",
      "name": "Create Session",
      "type": "n8n-nodes-base.postgres",
      "position": [1250, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "message",
        "modelId": "gpt-4-turbo-preview",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "„ÅÇ„Å™„Åü„ÅØAI„ÉÑ„Éº„É´Êé®Ëñ¶„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„ÄÅ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n{\n  \"task_type\": \"‰ΩúÊ•≠„ÅÆÁ®ÆÈ°û\",\n  \"complexity\": 1-10„ÅÆÊï∞ÂÄ§,\n  \"required_features\": [\"ÂøÖË¶Å„Å™Ê©üËÉΩ„ÅÆ„É™„Çπ„Éà\"],\n  \"skill_level\": \"beginner/intermediate/advanced\",\n  \"domain\": \"content_creation/data_analysis/programming/design/research/business/other\",\n  \"clarification_needed\": true/false,\n  \"clarification_questions\": [\"ÊòéÁ¢∫Âåñ„ÅåÂøÖË¶Å„Å™Ë≥™Âïè\"]\n}"
            },
            {
              "role": "user",
              "content": "={{ $('Parse Discord Data').item.json.message }}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 500,
          "responseFormat": {
            "type": "json_object"
          }
        }
      },
      "id": "u1v2w3x4-analyze",
      "name": "Analyze Task",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1450, 300],
      "credentials": {
        "openAiApi": {
          "id": "2",
          "name": "OpenAI API"
        }
      },
      "typeVersion": 1.5
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ai_tools WHERE \n  category = $1 AND \n  is_active = true AND\n  skill_level_min <= $2 AND\n  skill_level_max >= $2 AND\n  $3 = ANY(supported_languages)\nORDER BY popularity_score DESC, performance_score DESC\nLIMIT 10",
        "additionalFields": {
          "queryParams": "={{ [\n  $json.task_analysis.domain,\n  $json.task_analysis.complexity,\n  'ja'\n] }}"
        }
      },
      "id": "y5z6a7b8-tools",
      "name": "Search AI Tools",
      "type": "n8n-nodes-base.postgres",
      "position": [1650, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4
    },
    {
      "parameters": {
        "functionCode": "// „Çπ„Ç≥„Ç¢„É™„É≥„Ç∞Èñ¢Êï∞\nconst tools = $input.first().json;\nconst taskProfile = $('Analyze Task').first().json.task_analysis;\nconst userProfile = $('Get User Profile').first().json[0] || $('Create User Profile').first().json;\n\nconst calculateScore = (tool) => {\n  let score = 0;\n  \n  // „Çø„Çπ„ÇØÈÅ©ÂêàÊÄßÔºà30%Ôºâ\n  if (tool.category === taskProfile.domain) score += 0.3;\n  \n  // „Çπ„Ç≠„É´„É¨„Éô„É´‰∏ÄËá¥Â∫¶Ôºà20%Ôºâ\n  const skillMatch = 1 - Math.abs(tool.skill_level_min - taskProfile.complexity) / 10;\n  score += skillMatch * 0.2;\n  \n  // „Ç≥„Çπ„ÉàÂäπÁéáÔºà25%Ôºâ\n  const costScore = tool.pricing_model.free_tier ? 0.25 : 0.1;\n  score += costScore;\n  \n  // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÔºà15%Ôºâ\n  score += (tool.performance_score / 10) * 0.15;\n  \n  // Ë®ÄË™û„Çµ„Éù„Éº„ÉàÔºà5%Ôºâ\n  if (tool.supported_languages.includes('ja')) score += 0.05;\n  \n  // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶Ôºà5%Ôºâ\n  if (tool.context_window_size > 100000) score += 0.05;\n  \n  return score;\n};\n\nconst scoredTools = tools.map(tool => ({\n  ...tool,\n  recommendation_score: calculateScore(tool)\n}));\n\nconst topTools = scoredTools\n  .sort((a, b) => b.recommendation_score - a.recommendation_score)\n  .slice(0, 3);\n\nreturn [{ json: { recommended_tools: topTools } }];"
      },
      "id": "c9d0e1f2-score",
      "name": "Score & Rank Tools",
      "type": "n8n-nodes-base.code",
      "position": [1850, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "message",
        "modelId": "claude-3-opus-20240229",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "„ÅÇ„Å™„Åü„ÅØAIÂàùÂøÉËÄÖÂêë„Åë„ÅÆ„Ç¨„Ç§„Éâ‰ΩúÊàêÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß„ÄÅÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË∑µÁöÑ„Å™‰ΩøÁî®„Ç¨„Ç§„Éâ„ÇíÊó•Êú¨Ë™û„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\n## „Åä„Åô„Åô„ÇÅAI„ÉÑ„Éº„É´\n\n### 1. [„ÉÑ„Éº„É´Âêç]\n**ÁâπÂæ¥**: Á∞°ÊΩî„Å™Ë™¨Êòé\n**ÊñôÈáë**: ÂÖ∑‰ΩìÁöÑ„Å™ÊñôÈáë‰ΩìÁ≥ª\n**„Åì„Çì„Å™‰∫∫„Å´„Åä„Åô„Åô„ÇÅ**: ÂØæË±°„É¶„Éº„Ç∂„Éº\n\n#### ‰Ωø„ÅÑÊñπ\n1. „Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê„ÅÆÊâãÈ†Ü\n2. Âü∫Êú¨ÁöÑ„Å™‰Ωø„ÅÑÊñπ\n3. „ÅÇ„Å™„Åü„ÅÆ„Çø„Çπ„ÇØ„Åß„ÅÆÂÖ∑‰ΩìÁöÑ„Å™‰ΩøÁî®‰æã\n\n#### „Çµ„É≥„Éó„É´„Éó„É≠„É≥„Éó„Éà\n```\nÂÖ∑‰ΩìÁöÑ„Å™„Éó„É≠„É≥„Éó„Éà‰æã\n```\n\n#### üí° „Ç≥„ÉÑ\n- ÂÆüË∑µÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ\n\n---\n\nÂøÖ„Åö3„Å§„ÅÆ„ÉÑ„Éº„É´„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åó„ÄÅÂàùÂøÉËÄÖ„Åß„ÇÇËø∑„Çè„Å™„ÅÑ„Çà„ÅÜ„Å™ÂÖ∑‰ΩìÁöÑ„Å™ÊâãÈ†Ü„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            },
            {
              "role": "user",
              "content": "„É¶„Éº„Ç∂„Éº„ÅÆ„Çø„Çπ„ÇØ: {{ $('Parse Discord Data').item.json.message }}\n\nÊé®Â•®„ÉÑ„Éº„É´ÊÉÖÂ†±:\n{{ JSON.stringify($json.recommended_tools, null, 2) }}"
            }
          ]
        },
        "options": {
          "temperature": 0.3,
          "maxTokens": 2000
        }
      },
      "id": "g3h4i5j6-guide",
      "name": "Generate Guide",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [2050, 300],
      "credentials": {
        "openAiApi": {
          "id": "3",
          "name": "Claude API"
        }
      },
      "typeVersion": 1.5
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO tool_usage_history (session_id, user_id, tool_id, recommendation_score) \nSELECT $1, $2, unnest($3::uuid[]), unnest($4::decimal[])",
        "additionalFields": {
          "queryParams": "={{ [\n  $('Create Session').item.json.session_id,\n  $('Get User Profile').first().json[0]?.user_id || $('Create User Profile').first().json.user_id,\n  $('Score & Rank Tools').item.json.recommended_tools.map(t => t.id),\n  $('Score & Rank Tools').item.json.recommended_tools.map(t => t.recommendation_score)\n] }}"
        }
      },
      "id": "k7l8m9n0-history",
      "name": "Save Recommendations",
      "type": "n8n-nodes-base.postgres",
      "position": [2250, 400],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://discord.com/api/v10/interactions/{{ $('Parse Discord Data').item.json.interactionId }}/{{ $('Parse Discord Data').item.json.interactionToken }}/callback",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "4"
            },
            {
              "name": "data.content",
              "value": "={{ $('Generate Guide').item.json.choices[0].message.content }}"
            },
            {
              "name": "data.flags",
              "value": "64"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "o1p2q3r4-respond",
      "name": "Send Discord Response",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2450, 300],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "functionCode": "// „Ç®„É©„Éº„É≠„Ç∞„ÅÆË®òÈå≤\nconst error = $input.first().json.error;\nconst context = {\n  workflowId: $workflow.id,\n  executionId: $execution.id,\n  nodeId: error.node?.name,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{\n  json: {\n    error_type: error.name || 'UnknownError',\n    error_message: error.message,\n    error_stack: error.stack,\n    severity: 'high',\n    context\n  }\n}];"
      },
      "id": "s5t6u7v8-error",
      "name": "Format Error",
      "type": "n8n-nodes-base.code",
      "position": [1450, 500],
      "typeVersion": 2,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO error_logs (session_id, user_id, error_type, error_message, error_stack, severity, context) \nVALUES ($1, $2, $3, $4, $5, $6, $7)",
        "additionalFields": {
          "queryParams": "={{ [\n  $('Create Session').item.json?.session_id || null,\n  $('Get User Profile').first().json[0]?.user_id || null,\n  $json.error_type,\n  $json.error_message,\n  $json.error_stack,\n  $json.severity,\n  $json.context\n] }}"
        }
      },
      "id": "w9x0y1z2-log",
      "name": "Log Error",
      "type": "n8n-nodes-base.postgres",
      "position": [1650, 500],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Discord Butler DB"
        }
      },
      "typeVersion": 2.4,
      "continueOnFail": true
    }
  ],
  "connections": {
    "Discord Webhook": {
      "main": [
        [
          {
            "node": "Parse Discord Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Discord Data": {
      "main": [
        [
          {
            "node": "Get User Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Profile": {
      "main": [
        [
          {
            "node": "New User?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "New User?": {
      "main": [
        [
          {
            "node": "Create User Profile",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create User Profile": {
      "main": [
        [
          {
            "node": "Create Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Session": {
      "main": [
        [
          {
            "node": "Analyze Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Task": {
      "main": [
        [
          {
            "node": "Search AI Tools",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search AI Tools": {
      "main": [
        [
          {
            "node": "Score & Rank Tools",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Score & Rank Tools": {
      "main": [
        [
          {
            "node": "Generate Guide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Guide": {
      "main": [
        [
          {
            "node": "Save Recommendations",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Discord Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "error-handler-workflow"
  },
  "staticData": null,
  "pinData": {},
  "versionId": "d8f3e9a0-1234-5678-9abc-def012345678",
  "triggerCount": 1
}